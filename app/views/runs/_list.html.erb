<div class="box box-default">
  <div class="box-body">
    <table id="runsDataTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
      <thead>
      <tr>
        <th>Name</th>
        <th>Start time</th>
        <th>Duration</th>
        <th class="assignee-column">Assignee</th>
        <th>Result</th>
      </tr>
      </thead>
      <tbody>
      <% @runs.each do |run| %>
          <tr>
            <td><%= link_to run.name, suite_run_path(run.suite.id, run.id) %></td>
            <td><%= run.start_time.to_s(:db) %></td>
            <td><%= run.display_duration %></td>
            <td align="center">
              <div class="btn-group" role="group" style="width: 70%">
                <button type="button" class="btn-tester btn btn-xs btn-block dropdown-toggle"
                          data-toggle="dropdown"
                          data-run-id="<%= run.id %>">
                <%= run.tester_name %> <span class="caret"></span>
                </button>
                <ul class="dropdown-menu tester-dropdown-menu">
                  <% @testers.each do |tester| %>
                      <li><a data-tester-id="<%= tester.id %>" data-tester-name="<%= tester.name %>"><%= tester.name %></a></li>
                  <% end %>
                </ul>
              </div>
            </td>

            <% result = Result.find(run.result_id) %>
            <td><button type="button" class="btn btn-block <%= result.display_style_btn %> btn-xs"><%= result.name %></button></td>
          </tr>
      <% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Initialize datatable
  $(document).ready(function ()
  {
    $('#runsDataTable').on( 'draw.dt', function ()
    {
      $(".tester-dropdown-menu li a").off('click.runsdt');

      // Convert all list-based dropdown to <select>-like menus
      $(".tester-dropdown-menu li a").on('click.runsdt', function ()
      {
        var button = $(this).parents('.dropdown-menu').siblings('button');
        var tester_name = $(this).data('tester-name');

        $.ajax
        (
            {
              type: "PUT",
              url: "/api/suites/<%= params[:suite_id] || params[:id] %>/runs/" + button.data('run-id'),
              contentType: "application/json",
              dataType: "json",
              data: JSON.stringify({tester_id: $(this).data('tester-id')})
            }).done(function (response)
        {
          button.html(tester_name + ' <span class="caret"/>');
        });
      });
    });


    $('#runsDataTable').DataTable(
    {
      paging: <%= @runs.length > 10 ? 'true' : 'false' %>,
      pageLength: 10,
      info: false,
      lengthMenu: [ 10, 25, 50, 100 ],
      columnDefs: [
        { targets: ['assignee-column'], data: function(row, type, set, meta){
          if (type === 'set')
          {
            row.val = set;
            row.val_display = set;
            row.val_filter = $(set).find('.btn-tester').text();
          }
          else if (type === 'display')
          {
            return row.val_display
          }
          else if (type === 'filter')
          {
            return row.val_filter
          }

          return row.val;
        }}
      ]
    });

  });
</script>
