<div class="box box-primary">
  <div class="box-body">
    <table id="runsDataTable" class="table table-hover">
      <thead>
      <tr>
        <th>Name</th>
        <th>Start time</th>
        <th>Duration</th>
        <th class="assignee-column">Assignee</th>
        <th>Passed</th>
      </tr>
      </thead>
      <tbody>
      <% @runs.each do |run| %>
          <tr data-run-id="<%= run.id %>">
            <td class="col-xs-6"><%= link_to run.name, suite_run_path(run.suite.id, run.id) %></td>
            <td class="col-xs-2"><%= run.start_time ? run.start_time.to_s(:db) : 0 %></td>
            <td><%= run.display_duration %></td>

            <td class="col-xs-2" >
              <div class="btn-group" role="group" style="width: 70%">
                <button type="button" class="btn-tester btn btn-xs btn-block dropdown-toggle"
                          data-toggle="dropdown">
                <%= run.tester.name %> <span class="caret"></span>
                </button>
                <ul class="dropdown-menu tester-dropdown-menu">
                  <% testers_all.each do |tester| %>
                      <li><a data-tester-id="<%= tester.id %>" data-tester-name="<%= tester.name %>"><%= tester.name %></a></li>
                  <% end %>
                </ul>
              </div>
            </td>

            <td class="col-xs-2" style="padding-top: 5px">
              <%
                if run.stats_tests_error > 0 || run.stats_tests_fail > 0
                  progress_bar_class = 'progress-bar-danger'
                elsif run.stats_tests_skip > 0
                  progress_bar_class = 'progress-bar-warning'
                else
                  progress_bar_class = ''
                end
              %>
              <div class="progress <%= progress_bar_class %>">
                <% if run.stats_tests_running > 0 %>
                    <div class="progress-bar progress-bar-primary progress-bar-striped active"
                         style="width: 100%">
                      <span class="sr-only">0%</span>
                    </div>
                <%
                  else
                    tests_all     = run.stats_tests_all
                    tests_pass    = run.stats_tests_pass

                    if tests_pass == 0 || tests_all == 0
                      tests_ratio = 0
                    else
                      tests_ratio = ((tests_pass.to_f/tests_all) * 100).floor
                    end
                %>
                    <div class="progress-bar progress-bar-success"
                         style="width: <%= tests_ratio %>%">
                      <span><%= tests_ratio %>%</span>
                    </div>
                <% end %>
              </div>
            </td>
          </tr>
      <% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Initialize datatable
  $(document).ready(function ()
  {
    $('#runsDataTable').on( 'draw.dt', function ()
    {
      $(".tester-dropdown-menu li a").off('click.runsdt');

      // Convert all list-based dropdown to <select>-like menus
      $(".tester-dropdown-menu li a").on('click.runsdt', function ()
      {
        var testerName = $(this).data('tester-name');
        var runIds = [];
        var newTesterId = $(this).data('tester-id');

        if (table.rows('.selected').data().length > 0)
        {
          table.rows('.selected').every( function ( rowIdx, tableLoop, rowLoop )
          {
            runIds.push(table.row(rowIdx).node().getAttribute('data-run-id'));
          });
        }
        else
        {
          runIds.push($(this).parents('tr').data('run-id'));
        }
          console.log(runIds);
          console.log(newTesterId);
        changeRunsTester(runIds, newTesterId);
      });

      $(this).show();
    });

    function changeRunsTester(runIds, testerId)
    {
      var testers = []
      <% Tester.all.each do |tester| %>
        testers.push([<%= tester.id %>,"<%= tester.name %>"]);
      <% end %>

      $.ajax
      (
        {
          type: "PUT",
          url: "/api/suites/<%= params[:suite_id] || params[:id] %>/batchtesters",
          contentType: "application/json",
          dataType: "json",
          data: JSON.stringify({run_ids: runIds, tester_id: testerId})
      }).done(function (response)
      {
        // Update data on all buttons
        $.each(response, function(index)
        {
          console.log(response[index]);
          var button = $('tr[data-run-id="'+ response[index].id +'"]').find('.btn-tester');

          console.log(button);

          $.each(testers, function(index)
          {
              if ($(this)[0] == testerId)
              {
                  button.html($(this)[1] + ' <span class="caret"/>');
                  return false; // needs to return false in order to "break" from jQuery "each"...
              }
          });
        });
      });
    }

    // Initialize datatable
    var table = $('#runsDataTable').DataTable(
    {
      dom:
      "<'row'<'col-sm-6'lB><'col-sm-6'f>>" +
      "<'row'<'col-sm-12'tr>>" +
      "<'row'<'col-sm-12'p>>",
      select: {
          style:    'os',
          // ignoring certain cells with controls since they interfered with selection etc.
          selector: 'td:nth-of-type(1), td:nth-of-type(2), td:nth-of-type(3), td:nth-of-type(5)'
      },
      paging: <%= @runs.length > 25 %>,
      pageLength: 25,
      lengthMenu: [ 10, 25, 50, 100 ],
      columnDefs: [
        { targets: ['assignee-column'], data: function(row, type, set, meta){
          if (type === 'set')
          {
            row.val = set;
            row.val_display = set;
            row.val_filter = $(set).find('.btn-tester').text();
          }
          else if (type === 'display')
          {
            return row.val_display
          }
          else if (type === 'filter')
          {
            return row.val_filter
          }

          return row.val;
        }}
      ],
      order: [[1, 'desc']],
      buttons: [
          {
              extend: 'selectAll',
              className: 'selectall',
              text: 'Select visible',
              action : function(e) {
                  e.preventDefault();
                  table.rows().deselect();
                  table.rows({ page: 'current', search: 'applied'}).select();
              }
          },
          'selectNone'
      ]
    });

  });
</script>
